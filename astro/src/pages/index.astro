---
import { ViewTransitions } from 'astro:transitions';
import Timeline from "../components/Timeline.astro";
import timeline from "../data/timeline.json";
import { config } from "../config";

const items = (timeline as any[]);
// VERSION: Keep in sync with package.json version
const VERSION = "1.4.0";
const isDev = import.meta.env.DEV;

// Extract hashtags from timeline items
function extractHashtags(text: string): string[] {
  if (!text) return [];
  
  // Ignore list: common words, markdown headers, code snippets, technical noise
  const ignoreList = new Set([
    // Common words (markdown headers like "# How to...")
    '#how', '#make', '#should', '#you', '#the', '#and', '#for', '#with', '#from',
    '#this', '#that', '#will', '#can', '#are', '#have', '#has', '#more', '#about',
    '#what', '#when', '#where', '#why', '#who', '#which', '#their', '#there',
    
    // Technical/code snippets
    '#sudo', '#function_password', '#issue', '#issuecomment', '#convert', '#replace',
    '#append', '#clear', '#destroy', '#prints', '#allow', '#stdeb',
    
    // Wikipedia/platform IDs (wp followed by numbers)
    '#english', // Wikipedia category
    
    // Readwise internal/personal tags
    '#shortlist', '#fodder', '#software',
  ]);
  
  const hashtagRegex = /#[a-zA-Z][a-zA-Z0-9_]{2,}/g; // Must start with letter, 3+ chars total
  const matches = text.match(hashtagRegex);
  if (!matches) return [];
  
  return matches
    .map(tag => tag.toLowerCase())
    .filter(tag => {
      // Filter out hex color codes (e.g. #ffffff, #abc123)
      const withoutHash = tag.substring(1);
      const isHexColor = /^[0-9a-f]{3}$|^[0-9a-f]{6}$/i.test(withoutHash);
      
      // Filter out Wikipedia page IDs (#wp followed by numbers)
      const isWikipediaId = /^#wp\d+$/.test(tag);
      
      // Filter out ignored words/technical noise
      const isIgnored = ignoreList.has(tag);
      
      return !isHexColor && !isWikipediaId && !isIgnored;
    });
}

// Normalize/merge similar tags
function normalizeTag(tag: string): string {
  const tagMap: Record<string, string> = {
    '#incident_response': '#ir',
  };
  return tagMap[tag] || tag;
}

// Add hashtags to each item
const itemsWithHashtags = items.map(item => {
  // Extract hashtags from content (text-based)
  const titleTags = extractHashtags(item.title || '');
  const summaryTags = extractHashtags(item.summary || '');
  const contentTags = extractHashtags(item.content_html || '').slice(0, 10); // Limit from content
  
  // Use frontmatter tags (from blog posts, Readwise, etc.) - normalize to lowercase with # prefix
  // Also filter through extractHashtags to apply ignore list
  const frontmatterTags = (item.tags || [])
    .map((tag: string) => `#${tag.toLowerCase().replace(/\s+/g, '_')}`)
    .filter(tag => {
      // Apply same ignore list as text extraction
      const ignoreList = new Set([
        '#how', '#make', '#should', '#you', '#the', '#and', '#for', '#with', '#from',
        '#this', '#that', '#will', '#can', '#are', '#have', '#has', '#more', '#about',
        '#what', '#when', '#where', '#why', '#who', '#which', '#their', '#there',
        '#sudo', '#function_password', '#issue', '#issuecomment', '#convert', '#replace',
        '#append', '#clear', '#destroy', '#prints', '#allow', '#stdeb',
        '#english',
        '#shortlist', '#fodder', '#software',
      ]);
      return !ignoreList.has(tag);
    });
  
  // Add content type as a label for filtering
  // Map type to label name
  const typeLabels: Record<string, string> = {
    'blog': '#blog',
    'saved': '#article',
    'primer': '#primer',
    'bluesky': '#bluesky',
    'wikipedia': '#wikipedia',
    'release': '#release',
    'pixelfed': '#pixelfed',
    'hackernews': '#hackernews',
    'linkedin': '#linkedin'
  };
  const typeTag = typeLabels[item.type] ? [typeLabels[item.type]] : [];
  
  // Normalize all tags (merge similar ones)
  const allTags = [...typeTag, ...frontmatterTags, ...titleTags, ...summaryTags, ...contentTags]
    .map(tag => normalizeTag(tag));
  
  const hashtags = [...new Set(allTags)];
  return { ...item, hashtags };
});

// Get all unique hashtags with counts
const hashtagCounts = itemsWithHashtags.reduce((acc, item) => {
  item.hashtags.forEach((tag: string) => {
    acc[tag] = (acc[tag] || 0) + 1;
  });
  
  return acc;
}, {} as Record<string, number>);

const allHashtags = Object.entries(hashtagCounts)
  .sort((a, b) => b[1] - a[1]) // Sort by count descending
  .map(([tag, count]) => ({ tag, count }));
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>timeline.523.life ‚Äî Chase Pettet's Timeline</title>
  <meta name="description" content="A timeline of my online history featuring blog posts, saved articles, and social media activity.">
  <link rel="canonical" href="https://timeline.523.life/">
  <meta name="version" content={VERSION}>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link rel="alternate" type="application/rss+xml" title="Chase Pettet's Timeline" href="/rss.xml" />
  <ViewTransitions />
</head>
<body data-version={VERSION}>

<main>
  <div class="timeline-content">
    <header class="header">
      <h1>timeline.<a href="https://523.life" class="home-link">523.life</a></h1>
      <p>A timeline of my public online activity.</p>
      <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme" title="Toggle light/dark theme">
        <span class="theme-icon">üåô</span>
      </button>
    </header>

    <section class="controls" aria-label="Filters">
      <div class="search-row">
        <div class="search-container">
          <div class="search-input-wrapper">
            <input type="search" id="search-input" class="search-input" placeholder="Search timeline..." autocomplete="off" />
            <button id="search-clear" class="search-clear" hidden aria-label="Clear search">Clear</button>
          </div>
        </div>
        <div class="filter-actions-stacked">
          <button id="select-all" class="filter-action">All</button>
          <button id="select-none" class="filter-action">Clear</button>
        </div>
        <div class="results-count" id="results-count">
          <span class="results-count-number" id="results-count-number">0</span>
          <span class="results-count-label">results</span>
        </div>
      </div>
      <div class="filters-row">
        {allHashtags.length > 0 && (
          <div class="hashtag-dropdown-wrapper">
            <button class="hashtag-dropdown-button" id="hashtag-dropdown-btn" aria-haspopup="listbox" aria-expanded="false">
              <span class="dropdown-label">Labels</span>
              <span class="selected-count" id="selected-hashtag-count" hidden></span>
              <span class="dropdown-arrow">‚ñº</span>
            </button>
            <div class="hashtag-dropdown-menu" id="hashtag-dropdown-menu" hidden role="listbox" aria-label="Select hashtags">
              {allHashtags.map(({ tag, count }) => (
                <div class="hashtag-option" role="option" aria-selected="false" data-hashtag={tag} tabindex="0">
                  <span class="hashtag-text">{tag.replace('#', '')}</span>
                  <span class="hashtag-count" data-hashtag-count={tag}>{count}</span>
                </div>
              ))}
            </div>
          </div>
        )}
        <div class="filters" role="group" aria-label="Content types">
          <label title="Bookmarks, posts, and social content"><input type="checkbox" name="type" value="saved,bluesky,pixelfed,hackernews,linkedin,primer" checked> Shared</label>
          <label title="Technical writing and essays"><input type="checkbox" name="type" value="blog" checked> Written</label>
          <label title="Contributions to Wikipedia and other platforms"><input type="checkbox" name="type" value="wikipedia,release" checked> Contributed</label>
        </div>
      </div>
    </section>

    <Timeline items={itemsWithHashtags} config={config} />
  </div>

  <div class="backdrop" id="panel-backdrop" hidden></div>
  <aside class="panel" id="detail-panel" role="complementary" aria-labelledby="panel-title">
    <div class="swipe-indicator" id="swipe-indicator" hidden></div>
    <header class="panel-header">
      <button id="panel-close-left" class="panel-close-btn" aria-label="Close" title="Close">√ó</button>
      <h2 id="panel-title">
        <span id="panel-title-text">About</span>
        <span id="panel-source-wrapper" hidden> | <a id="panel-source" href="#" target="_blank" rel="noopener" class="panel-source-link">Source ‚Üó</a></span>
      </h2>
      <button id="panel-copy-link" class="panel-copy-btn" aria-label="Copy link" title="Copy link to this timeline entry" hidden>üîó</button>
    </header>
    <div id="panel-content">
      <div class="intro">
        <p class="intro-description">This is a chronological archive of my online presence, bringing together different content streams into a single unified view.</p>
        
        <div class="about-section">
        <h4>Content Types</h4>
        <ul class="legend">
            <li>
              <span class="legend-dot" data-dot-type="saved"></span>
              <span class="legend-text">
                <strong>Shared</strong>
                <span class="legend-description">‚Äî Bookmarks, posts, and social content</span>
              </span>
            </li>
            <li>
              <span class="legend-dot" data-dot-type="blog"></span>
              <span class="legend-text">
                <strong>Written</strong>
                <span class="legend-description">‚Äî Technical writing and essays</span>
              </span>
            </li>
            <li>
              <span class="legend-dot" data-dot-type="wikipedia"></span>
              <span class="legend-text">
                <strong>Contributed</strong>
                <span class="legend-description">‚Äî Wikipedia and other contributions</span>
              </span>
            </li>
        </ul>
        </div>
        
        <div class="about-section">
        <h4>How to Use</h4>
          <ul class="how-to-use">
            <li>Click on any item in the timeline to read more.</li>
            <li>Use the filters above to show or hide different content types.</li>
            <li>Hover over the colored top bar to see timestamps.</li>
          </ul>
        </div>
        
        <div class="about-section">
        <h4>Comments</h4>
        <p>Each timeline item and blog post has its own discussion thread powered by GitHub Discussions. To leave a comment, you'll need to authorize the <a href="https://giscus.app/" target="_blank" rel="noopener">giscus</a> app‚Äîthis allows it to create and post comments on your behalf within this repository's discussion threads only.</p>
        </div>
        
        <p class="muted-text">Built with Astro ‚Ä¢ Data fetched from multiple sources</p>
      </div>
    </div>
  </aside>
</main>

<footer>
  <p>¬© 2025 Chase Pettet ‚Äî <a href="https://523.life">523.life</a> <span class="version">v{VERSION}</span> ¬∑ Built with <a href="https://astro.build" target="_blank" rel="noopener">Astro</a> ¬∑ <a href="https://giscus.app/" target="_blank" rel="noopener">giscus</a> ¬∑ <a href="/rss.xml" target="_blank" rel="noopener">RSS Feed</a></p>
</footer>

<style is:global>
  /* Dark theme (darker old book - default) */
  :root[data-theme="dark"], :root:not([data-theme]) {
    --bg: #2a2419;
    --panel: #342d23;
    --text: #e8dcc4;
    --muted: #a89a84;
    --accent: #d4956f;
    --spine: #4a3f32;
    --border: #4a3f32;
    --card-bg: #3a3228;
    --search-highlight-bg: #d4956f;
    --search-highlight-text: #2a2419;
  }
  
  /* Light theme (old book) */
  :root[data-theme="light"] {
    --bg: #f4ecd8;
    --panel: #faf6ed;
    --text: #3d2817;
    --muted: #7a6b5d;
    --accent: #c17a4f;
    --spine: #d4c4a8;
    --border: #d4c4a8;
    --card-bg: #fdfbf7;
    --search-highlight-bg: #c17a4f;
    --search-highlight-text: #fdfbf7;
  }
  
  /* Search highlight styling */
  mark, .search-highlight {
    background-color: var(--search-highlight-bg) !important;
    color: var(--search-highlight-text) !important;
    border-radius: 2px;
    padding: 0 1px;
  }
  html, body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font: 16px/1.6 Georgia, "Times New Roman", serif; transition: background-color 0.3s ease, color 0.3s ease; }
  main { max-width: 1200px; margin: 0 auto; padding: 24px; display: grid; grid-template-columns: 1fr minmax(320px, 420px); gap: 24px; }
  footer { max-width: 1200px; margin: 0 auto; padding: 24px 24px 32px; text-align: center; }
  footer p { margin: 0; color: var(--muted); font-size: 14px; }
  footer a { color: var(--accent); text-decoration: none; }
  footer a:hover { text-decoration: underline; }
  footer .version { opacity: 0.5; font-size: 12px; margin-left: 8px; }
  .timeline-content { grid-column: 1; }
  .header { text-align: center; margin-bottom: 16px; position: relative; }
  .header h1 { margin: 0 0 4px; font-size: 32px; font-weight: 600; color: var(--accent); letter-spacing: -0.02em; }
  .header p { margin: 0 0 16px; color: var(--muted); font-size: 15px; }
  .theme-toggle { position: absolute; top: 0; right: 0; background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; cursor: pointer; font-size: 18px; transition: all 0.2s; }
  .theme-toggle:hover { background: var(--panel); border-color: var(--accent); transform: scale(1.05); }
  .theme-icon { display: inline-block; }
  .home-link { color: inherit; text-decoration: none; transition: opacity 0.2s; }
  .home-link:hover { opacity: 0.7; text-decoration: underline; }
  .controls { position: sticky; top: 0; background: var(--bg); padding: 12px 0; z-index: 10; backdrop-filter: blur(8px); margin-bottom: 12px; min-height: 100px; border-bottom: 1px solid transparent; }
  .search-row { display: flex; gap: 12px; align-items: center; justify-content: center; margin-bottom: 12px; }
  .search-container { min-width: 200px; max-width: 450px; min-height: 40px; flex-shrink: 0; flex: 1; }
  .search-input-wrapper { position: relative; display: flex; align-items: center; }
  .search-input { width: 100%; padding: 10px 16px; padding-right: 60px; border: 2px solid var(--border); border-radius: 8px; background: var(--card-bg); color: var(--text); font-size: 16px; font-family: Georgia, "Times New Roman", serif; outline: none; transition: border-color 0.2s; box-sizing: border-box; }
  .search-input:focus { border-color: var(--accent); }
  .search-input::placeholder { color: var(--muted); opacity: 0.7; }
  .search-clear { position: absolute; right: 8px; background: transparent; border: none; color: var(--muted); font-size: 13px; cursor: pointer; padding: 4px 8px; font-family: Georgia, "Times New Roman", serif; transition: color 0.2s; }
  .search-clear:hover { color: var(--accent); }
  .search-result-count { color: var(--muted); font-size: 13px; margin-top: 4px; font-family: system-ui, sans-serif; }
  .filter-actions-stacked { display: flex; flex-direction: column; gap: 2px; height: 40px; justify-content: center; }
  .filter-action { background: transparent; padding: 0; border: none; color: var(--text); font-size: 12px; cursor: pointer; transition: all 0.2s; font-family: Georgia, "Times New Roman", serif; font-weight: 600; text-decoration: underline; text-decoration-color: transparent; line-height: 1.2; }
  .filter-action:hover { color: var(--accent); text-decoration-color: var(--accent); }
  .results-count { display: flex; align-items: center; gap: 4px; color: var(--muted); font-size: 14px; font-family: system-ui, sans-serif; white-space: nowrap; }
  .results-count-number { font-weight: 600; color: var(--accent); }
  .results-count-label { opacity: 0.8; }
  .filters-row { display: flex; gap: 12px; align-items: center; justify-content: center; flex-wrap: wrap; }
  .filters { display: flex; gap: 8px; flex-wrap: wrap; }
  .filters label { background: var(--card-bg); padding: 6px 12px; border-radius: 999px; border: 1px solid var(--border); color: var(--muted); font-size: 14px; cursor: pointer; transition: all 0.2s; }
  .filters label:hover { background: var(--panel); border-color: var(--accent); color: var(--text); }
  .filters label:has(input:checked) { border-color: var(--accent); border-width: 2px; color: var(--text); }
  .filters label:has(input:checked):hover { background: var(--panel); }
  .filters input[type="checkbox"] { position: absolute; opacity: 0; width: 0; height: 0; pointer-events: none; }
  
  .hashtag-dropdown-wrapper { position: relative; flex-shrink: 0; }
  .hashtag-dropdown-button { background: var(--card-bg); padding: 6px 12px; border-radius: 999px; border: 1px solid var(--border); color: var(--muted); font-size: 14px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
  .hashtag-dropdown-button:hover { background: var(--panel); border-color: var(--accent); color: var(--text); }
  .hashtag-dropdown-button[aria-expanded="true"] { border-color: var(--accent); border-width: 2px; color: var(--text); }
  .hashtag-dropdown-button.has-selection { border-color: var(--accent); border-width: 2px; color: var(--text); }
  .hashtag-dropdown-button.flash-notification { animation: flashPulse 0.6s ease-out; }
  @keyframes flashPulse {
    0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 var(--accent); }
    25% { transform: scale(1.05); box-shadow: 0 0 0 4px rgba(193, 122, 79, 0.3); }
    50% { transform: scale(1); box-shadow: 0 0 0 8px rgba(193, 122, 79, 0.1); }
  }
  .dropdown-label { font-weight: 600; }
  .selected-count { background: var(--accent); color: var(--bg); padding: 1px 6px; border-radius: 999px; font-size: 11px; font-weight: 600; }
  .dropdown-arrow { font-size: 10px; transition: transform 0.2s; }
  .hashtag-dropdown-button[aria-expanded="true"] .dropdown-arrow { transform: rotate(180deg); }
  .hashtag-dropdown-menu { position: absolute; top: 100%; left: 50%; transform: translateX(-50%); margin-top: 4px; background: var(--panel); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); max-height: 300px; overflow-y: auto; z-index: 100; min-width: 200px; }
  .hashtag-option { display: flex; align-items: center; gap: 8px; padding: 8px 14px; cursor: pointer; transition: all 0.15s; border-bottom: 1px solid var(--border); }
  .hashtag-option:first-child { border-radius: 8px 8px 0 0; }
  .hashtag-option:last-child { border-bottom: none; border-radius: 0 0 8px 8px; }
  .hashtag-option:hover { background: var(--card-bg); }
  .hashtag-option.selected { background: var(--card-bg); color: var(--accent); }
  .hashtag-option.selected .hashtag-text { color: var(--accent); font-weight: 600; }
  .hashtag-option.selected .hashtag-count { color: var(--accent); opacity: 0.8; }
  .hashtag-option .hashtag-text { flex: 1; font-size: 13px; color: var(--text); font-family: system-ui, sans-serif; }
  .hashtag-option .hashtag-count { opacity: 0.5; font-size: 11px; color: var(--muted); font-family: system-ui, sans-serif; flex-shrink: 0; }
  
  /* Panel styles */
  .panel { 
    position: sticky; 
    top: 12px; 
    align-self: start; 
    height: calc(100dvh - 24px); 
    background: var(--panel); 
    border: 1px solid var(--border); 
    border-radius: 12px; 
    padding: 20px; 
    overflow: auto; 
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    box-sizing: border-box;
    max-width: 100%;
  }
  .panel-header { display: flex; align-items: center; gap: 12px; border-bottom: 2px solid var(--border); padding-bottom: 14px; margin-bottom: 20px; }
  .panel-header h2 { margin: 0; font-size: 14px; color: var(--muted); font-weight: 600; flex: 1; text-transform: uppercase; letter-spacing: 0.05em; font-family: system-ui, sans-serif; display: flex; align-items: center; flex-wrap: wrap; gap: 8px; justify-content: center; }
  .panel-source-link { color: var(--accent); text-decoration: none; font-size: 13px; font-weight: 600; transition: all 0.2s; white-space: nowrap; font-family: Georgia, "Times New Roman", serif; text-transform: none; letter-spacing: normal; }
  .panel-source-link:hover { text-decoration: underline; }
  .panel-close-btn { background: var(--card-bg); color: var(--text); border: 1px solid var(--border); border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 24px; line-height: 1; transition: all 0.2s; font-weight: 300; flex-shrink: 0; }
  .panel-close-btn:hover { background: var(--bg); border-color: var(--accent); color: var(--accent); }
  .panel-copy-btn { background: var(--card-bg); color: var(--text); border: 1px solid var(--border); border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 18px; line-height: 1; transition: all 0.2s; flex-shrink: 0; }
  .panel-copy-btn:hover { background: var(--bg); border-color: var(--accent); color: var(--accent); }
  .panel-copy-btn.copied { background: var(--accent); color: var(--bg); border-color: var(--accent); }
  #panel-close-left { order: -1; }
  #panel-copy-link { order: 1; }
  
  /* Show close button on desktop when viewing detail content (not intro) */
  @media (min-width: 981px) {
    #panel-close-left:not([hidden]) {
      display: block;
    }
  }
  #panel-content { 
    line-height: 1.7; 
    max-width: 100%;
    overflow-wrap: break-word;
    word-wrap: break-word;
    word-break: break-word;
    box-sizing: border-box;
  }
  .intro { margin: 0; }
  .intro-description { margin: 0 0 32px 0; color: var(--text); line-height: 1.7; }
  .about-section { margin: 0 0 32px 0; }
  .about-section:last-of-type { margin-bottom: 0; }
  #panel-content h3 { margin: 0 0 14px; font-size: 20px; color: #6d4c41; font-weight: 600; word-wrap: break-word; }
  #panel-content h4 { margin: 0 0 16px 0; font-size: 13px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--accent); font-weight: 700; font-family: system-ui, sans-serif; }
  #panel-content p { margin: 0 0 12px 0; color: var(--text); word-wrap: break-word; overflow-wrap: break-word; line-height: 1.7; }
  #panel-content p:last-child { margin-bottom: 0; }
  #panel-content a { color: #c17a4f; text-decoration: underline; text-decoration-color: rgba(193, 122, 79, 0.3); text-decoration-thickness: 1px; word-break: break-all; }
  #panel-content a:hover { text-decoration-color: var(--accent); }
  .muted-text { color: var(--muted); font-size: 13px; font-style: italic; margin-top: 32px; margin-bottom: 0; }
  .legend { list-style: none; padding: 0; margin: 0; }
  .legend li { display: grid; grid-template-columns: 12px 1fr; gap: 12px; margin: 0 0 16px 0; line-height: 1.6; align-items: start; }
  .legend li:last-child { margin-bottom: 0; }
  .legend-dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1); margin-top: 2px; }
  .legend-text { 
    color: var(--text); 
    word-break: normal !important; 
    overflow-wrap: normal !important; 
    hyphens: none !important;
  }
  .legend-text strong {
    display: block;
    margin-bottom: 4px;
  }
  .legend-description {
    display: block;
  }
  .how-to-use { list-style: none; padding: 0; margin: 0; }
  .how-to-use li { 
    margin: 0 0 12px 0; 
    padding-left: 22px; 
    position: relative; 
    line-height: 1.6; 
    color: var(--text);
    word-break: normal;
    overflow-wrap: break-word;
  }
  .how-to-use li:last-child { margin-bottom: 0; }
  .how-to-use li::before { 
    content: "‚Ä¢"; 
    position: absolute; 
    left: 0; 
    top: 0;
    color: var(--accent); 
    font-weight: 900; 
    font-size: 20px; 
    line-height: 1.6;
  }
  .legend-dot[data-dot-type="blog"] { background: #5d4037; }
  .legend-dot[data-dot-type="saved"] { background: #7cb342; }
  .legend-dot[data-dot-type="linkedin"] { background: #0a66c2; }
  .legend-dot[data-dot-type="bluesky"] { background: #1e88e5; }
  .legend-dot[data-dot-type="pixelfed"] { background: #e91e63; }
  .legend-dot[data-dot-type="hackernews"] { background: #ff6600; }
  .legend-dot[data-dot-type="release"] { background: #fb8c00; }
  .legend-dot[data-dot-type="wikipedia"] { background: #636466; }
  .detail-title { margin: 0 0 16px; font-size: 22px; color: #6d4c41; line-height: 1.3; word-wrap: break-word; }
  .detail-content { margin: 16px 0; max-width: 100%; overflow-wrap: break-word; }
  .detail-metadata { margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--border); color: var(--muted); font-size: 14px; font-family: system-ui, sans-serif; }
  .detail-content img { 
    max-width: 100% !important; 
    width: 100% !important;
    height: auto !important; 
    border-radius: 8px; 
    margin: 12px 0; 
    border: 1px solid var(--border); 
    object-fit: contain;
    display: block;
    box-sizing: border-box;
  }
  /* Ensure all media content fits within panel */
  #panel-content img,
  #panel-content iframe,
  #panel-content video,
  #panel-content embed,
  #panel-content object {
    max-width: 100% !important;
    width: 100% !important;
    height: auto !important;
    box-sizing: border-box;
  }
  #panel-content iframe,
  #panel-content embed,
  #panel-content object {
    aspect-ratio: 16 / 9;
  }
  #panel-content video {
    aspect-ratio: auto;
  }
  .panel-comments { margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border); }
  .backdrop { display: none; position: fixed; inset: 0; background: rgba(61, 40, 23, 0.6); backdrop-filter: blur(4px); z-index: 99; }
  .swipe-indicator { display: none; }

  @media (max-width: 980px) {
    main { display: block; }
    .timeline-content { grid-column: auto; }
    
    /* On mobile, show the panel at top with intro visible by default */
    .panel { 
      position: static; 
      height: auto; 
      margin-bottom: 24px;
      border-radius: 12px;
      max-width: 100%;
      box-sizing: border-box;
    }
    
    /* When opening detail content, use fixed drawer */
    .panel.mobile-detail-open { 
      position: fixed; 
      inset: auto 0 0 0; 
      height: 80dvh; 
      border-radius: 20px 20px 0 0; 
      z-index: 100; 
      margin-bottom: 0;
      overflow-y: auto;
      width: 100%;
      box-sizing: border-box;
    }
    
    /* Ensure panel content doesn't overflow on mobile */
    #panel-content {
      max-width: 100%;
      overflow-wrap: break-word;
      word-wrap: break-word;
    }
    
    #panel-content img,
    #panel-content iframe,
    #panel-content video {
      max-width: 100% !important;
      height: auto !important;
    }
    
    .backdrop:not([hidden]) { display: block; }
    .swipe-indicator { 
      display: none; /* Hidden by default */
    }
    
    /* Only show swipe indicator when detail is open */
    .panel.mobile-detail-open .swipe-indicator {
      display: block; 
      width: 40px; 
      height: 4px; 
      background: var(--muted); 
      border-radius: 2px; 
      margin: 12px auto 8px; 
      opacity: 0.6; 
    }
    
    /* Hide close button until detail is opened */
    .panel:not(.mobile-detail-open) #panel-close-left {
      display: none;
    }
  }
  
  @media (max-width: 640px) {
    .search-row { flex-wrap: wrap; gap: 8px; }
    .search-container { flex: 1 1 100%; max-width: none; }
    .filter-actions-stacked { flex-direction: row; gap: 12px; height: auto; }
    .filters-row { justify-content: center; }
    .hashtag-dropdown-menu { left: 0; transform: none; }
    .header h1 { padding-right: 60px; font-size: 28px; }
    .theme-toggle { padding: 6px 10px; font-size: 16px; }
  }
</style>

<script>
  // Theme toggle with cross-domain cookie support
  const themeToggle = document.getElementById('theme-toggle');
  const themeIcon = themeToggle?.querySelector('.theme-icon');
  const html = document.documentElement;
  
  // Cookie helper functions
  function setCookie(name, value, days = 365) {
    const expires = new Date();
    expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
    document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/;domain=.523.life`;
  }
  
  function getCookie(name) {
    const nameEQ = name + "=";
    const ca = document.cookie.split(';');
    for (let i = 0; i < ca.length; i++) {
      let c = ca[i];
      while (c.charAt(0) === ' ') c = c.substring(1, c.length);
      if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
  }
  
  // Load saved theme or default to dark (matching 523.life)
  const savedTheme = getCookie('theme') || 'dark';
  html.setAttribute('data-theme', savedTheme);
  if (themeIcon) themeIcon.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
  
  themeToggle?.addEventListener('click', () => {
    const currentTheme = html.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-theme', newTheme);
    setCookie('theme', newTheme);
    if (themeIcon) themeIcon.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    
    // Update Giscus theme if it's loaded
    const giscusFrame = document.querySelector('iframe.giscus-frame') as HTMLIFrameElement;
    if (giscusFrame) {
      giscusFrame.contentWindow?.postMessage(
        { giscus: { setConfig: { theme: newTheme } } },
        'https://giscus.app'
      );
    }
  });

  // Custom client-side search
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const searchClear = document.getElementById('search-clear') as HTMLButtonElement;
  let searchQuery = '';

  searchInput?.addEventListener('input', () => {
    searchQuery = searchInput.value.trim().toLowerCase();
    searchClear.hidden = searchQuery.length === 0;
    document.dispatchEvent(new CustomEvent('search:changed', { detail: { query: searchQuery } }));
  });

  searchClear?.addEventListener('click', () => {
    searchInput.value = '';
    searchQuery = '';
    searchClear.hidden = true;
    document.dispatchEvent(new CustomEvent('search:changed', { detail: { query: '' } }));
  });

  const params = new URLSearchParams(location.search);
  const selected = new Set((params.get('types') ?? 'blog,saved,bluesky,pixelfed,hackernews,linkedin,release,wikipedia').split(',').filter(Boolean));
  
  const checkboxes = document.querySelectorAll('input[name="type"]') as NodeListOf<HTMLInputElement>;
  
  // Function to expand checkbox values (e.g., "bluesky,pixelfed" -> ["bluesky", "pixelfed"])
  function expandCheckboxValue(value: string): string[] {
    return value.split(',').filter(Boolean);
  }
  
  // Function to check if a checkbox should be checked based on selected types
  function shouldCheckboxBeChecked(checkboxValue: string): boolean {
    const expanded = expandCheckboxValue(checkboxValue);
    return expanded.some(type => selected.has(type));
  }
  
  checkboxes.forEach((input) => {
    input.checked = shouldCheckboxBeChecked(input.value);
    input.addEventListener('change', updateFilters);
  });
  
  function updateFilters() {
    const allSelectedTypes = new Set<string>();
    
    // Expand all checked checkbox values and add to set
    Array.from(checkboxes)
      .filter((i) => i.checked)
      .forEach((i) => {
        expandCheckboxValue(i.value).forEach(type => allSelectedTypes.add(type));
      });
    
    const values = Array.from(allSelectedTypes);
    
    if (values.length === 0) {
      params.delete('types');
    } else {
      params.set('types', values.join(','));
    }
    
    history.replaceState({}, '', params.toString() ? `?${params.toString()}` : location.pathname);
    document.dispatchEvent(new CustomEvent('filters:changed', { detail: { types: values } }));
  }
  
  // Hashtag dropdown filtering - declare early for use in None button
  const selectedHashtags = new Set<string>();
  const hashtagDropdownBtn = document.getElementById('hashtag-dropdown-btn');
  const hashtagDropdownMenu = document.getElementById('hashtag-dropdown-menu');
  const selectedCountBadge = document.getElementById('selected-hashtag-count');
  const hashtagOptions = document.querySelectorAll('.hashtag-option[data-hashtag]') as NodeListOf<HTMLElement>;

  // Helper function to get checkbox value(s) for a hashtag
  function getCheckboxValuesForHashtag(hashtag: string): string[] {
    const hashtagToTypes: Record<string, string[]> = {
      '#blog': ['blog'],
      '#article': ['saved', 'bluesky', 'pixelfed', 'hackernews', 'linkedin', 'primer'],  // Shared category
      '#bluesky': ['saved', 'bluesky', 'pixelfed', 'hackernews', 'linkedin', 'primer'],  // Shared category
      '#pixelfed': ['saved', 'bluesky', 'pixelfed', 'hackernews', 'linkedin', 'primer'], // Shared category
      '#hackernews': ['saved', 'bluesky', 'pixelfed', 'hackernews', 'linkedin', 'primer'], // Shared category
      '#linkedin': ['blog', 'saved', 'bluesky', 'pixelfed', 'hackernews', 'linkedin', 'primer'], // LinkedIn can be in Written or Shared
      '#wikipedia': ['wikipedia'],
      '#release': ['wikipedia', 'release']
    };
    return hashtagToTypes[hashtag] || [];
  }

  // All button - checks all content types AND clears label filters
  document.getElementById('select-all')?.addEventListener('click', () => {
    checkboxes.forEach((input) => input.checked = true);
    
    // Clear all selected hashtags
    hashtagOptions.forEach((opt) => { opt.classList.remove('selected'); opt.setAttribute('aria-selected', 'false'); });
    selectedHashtags.clear();
    updateHashtagFilters();

    updateFilters();
  });

  // None button - clears content types, labels, AND search
  document.getElementById('select-none')?.addEventListener('click', () => {
    checkboxes.forEach((input) => input.checked = false);

    // Clear all selected hashtags
    hashtagOptions.forEach((opt) => { opt.classList.remove('selected'); opt.setAttribute('aria-selected', 'false'); });
    selectedHashtags.clear();
    updateHashtagFilters();
    
    // Clear search box
    const searchEl = document.getElementById('search-input') as HTMLInputElement;
    if (searchEl) {
      searchEl.value = '';
      searchEl.dispatchEvent(new Event('input', { bubbles: true }));
    }
    
    updateFilters();
  });

  function updateHashtagFilters() {
    document.dispatchEvent(new CustomEvent('hashtag:changed', {
      detail: { hashtags: Array.from(selectedHashtags) }
    }));

    // Update count badge and button state
    if (selectedHashtags.size > 0) {
      selectedCountBadge!.textContent = selectedHashtags.size.toString();
      selectedCountBadge!.removeAttribute('hidden');
      hashtagDropdownBtn?.classList.add('has-selection');
    } else {
      selectedCountBadge!.setAttribute('hidden', '');
      hashtagDropdownBtn?.classList.remove('has-selection');
    }
  }

  // Toggle dropdown
  hashtagDropdownBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    const isExpanded = hashtagDropdownBtn.getAttribute('aria-expanded') === 'true';
    
    if (isExpanded) {
      hashtagDropdownMenu?.setAttribute('hidden', '');
      hashtagDropdownBtn.setAttribute('aria-expanded', 'false');
    } else {
      hashtagDropdownMenu?.removeAttribute('hidden');
      hashtagDropdownBtn.setAttribute('aria-expanded', 'true');
    }
  });

  // Handle option clicks (toggle selection)
  hashtagOptions.forEach((option) => {
    option.addEventListener('click', (e) => {
      e.stopPropagation();
      const hashtag = option.dataset.hashtag!;
      const isSelected = selectedHashtags.has(hashtag);

      if (!isSelected) {
        selectedHashtags.add(hashtag);
        option.classList.add('selected');
        option.setAttribute('aria-selected', 'true');

        // Auto-check the corresponding categories when a hashtag is selected
        const requiredTypes = getCheckboxValuesForHashtag(hashtag);
        if (requiredTypes.length > 0) {
          let needsUpdate = false;
          checkboxes.forEach((categoryCheckbox) => {
            const categoryTypes = expandCheckboxValue(categoryCheckbox.value);
            if (categoryTypes.some(type => requiredTypes.includes(type)) && !categoryCheckbox.checked) {
              categoryCheckbox.checked = true;
              needsUpdate = true;
            }
          });
          if (needsUpdate) {
            updateFilters();
          }
        }
      } else {
        selectedHashtags.delete(hashtag);
        option.classList.remove('selected');
        option.setAttribute('aria-selected', 'false');
      }

      updateHashtagFilters();
      updateCardHashtagStyles();
    });

    // Keyboard support
    option.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        option.click();
      }
    });
  });

  // Handle hashtag clicks from cards
  window.addEventListener('hashtag:click', ((e: CustomEvent) => {
    const hashtag = e.detail.tag;
    
    // Toggle the hashtag selection
    if (selectedHashtags.has(hashtag)) {
      selectedHashtags.delete(hashtag);
    } else {
      selectedHashtags.add(hashtag);
      
      // Auto-check the corresponding categories when a hashtag is selected
      const requiredTypes = getCheckboxValuesForHashtag(hashtag);
      if (requiredTypes.length > 0) {
        let needsUpdate = false;
        checkboxes.forEach((categoryCheckbox) => {
          const categoryTypes = expandCheckboxValue(categoryCheckbox.value);
          // Check if this category checkbox includes any of the required types
          if (categoryTypes.some(type => requiredTypes.includes(type)) && !categoryCheckbox.checked) {
            categoryCheckbox.checked = true;
            needsUpdate = true;
          }
        });
        if (needsUpdate) {
          updateFilters();
        }
      }
    }
    
    // Update corresponding option in dropdown
    const option = Array.from(hashtagOptions).find(opt => opt.dataset.hashtag === hashtag);
    if (option) {
      if (selectedHashtags.has(hashtag)) {
        option.classList.add('selected');
        option.setAttribute('aria-selected', 'true');
      } else {
        option.classList.remove('selected');
        option.setAttribute('aria-selected', 'false');
      }
    }
    
    updateHashtagFilters();
    updateCardHashtagStyles();
    
    // Briefly flash the dropdown to show something happened
    if (selectedHashtags.has(hashtag)) {
      hashtagDropdownBtn?.classList.add('flash-notification');
      setTimeout(() => hashtagDropdownBtn?.classList.remove('flash-notification'), 600);
    }
  }) as EventListener);

  // Update visual state of hashtags on cards
  function updateCardHashtagStyles() {
    document.querySelectorAll('.card-hashtag').forEach((hashtag) => {
      const tag = (hashtag as HTMLElement).dataset.hashtag;
      if (tag && selectedHashtags.has(tag)) {
        hashtag.classList.add('hashtag-selected');
      } else {
        hashtag.classList.remove('hashtag-selected');
      }
    });
  }

  // Initialize hashtag styles on load
  updateCardHashtagStyles();

  // Dynamic label counts based on visible (type-filtered) rows
  function updateLabelCounts() {
    const counts: Record<string, number> = {};
    document.querySelectorAll('.row').forEach((row) => {
      const el = row as HTMLElement;
      // Count rows that pass the type filter (visible or only hidden by hashtag filter)
      // We check type filter directly to avoid circular dependency with hashtag filter
      const rowType = el.dataset.type;
      const checkedTypes = Array.from(document.querySelectorAll('input[name="type"]:checked') as NodeListOf<HTMLInputElement>)
        .flatMap(i => i.value.split(',').filter(Boolean));
      const typeAllowed = checkedTypes.length === 0 ? false : checkedTypes.includes(rowType!);
      if (!typeAllowed) return;

      const hashtags = el.dataset.hashtags?.split(',').filter(Boolean) || [];
      hashtags.forEach(tag => {
        counts[tag] = (counts[tag] || 0) + 1;
      });
    });

    hashtagOptions.forEach((option) => {
      const tag = option.dataset.hashtag!;
      const countEl = option.querySelector('.hashtag-count') as HTMLElement;
      if (countEl) {
        const count = counts[tag] || 0;
        countEl.textContent = count.toString();
      }
    });
  }

  // Update counts on filter changes and initial load
  updateLabelCounts();
  document.addEventListener('filters:changed', () => updateLabelCounts());

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!hashtagDropdownBtn?.contains(e.target as Node) && !hashtagDropdownMenu?.contains(e.target as Node)) {
      hashtagDropdownMenu?.setAttribute('hidden', '');
      hashtagDropdownBtn?.setAttribute('aria-expanded', 'false');
    }
  });
</script>

  <footer style="text-align: center; padding: 40px 16px; color: var(--muted); font-size: 14px;">
    <p>
      <a href="https://523.life" style="color: var(--accent); text-decoration: none;">‚Üê Back to 523.life</a>
    </p>
  </footer>

</main>

</body>
</html>
